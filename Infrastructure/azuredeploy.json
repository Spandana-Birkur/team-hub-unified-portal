{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "siteName": {
      "type": "string",
      "metadata": {
        "description": "ihopethisworks"
      }
    },
    "servicePlanName": {
      "type": "string",
      "metadata": {
        "description": "ASP-Access-9f99"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "East US"
      }
    },
    "sqlServerName": {
      "type": "string",
      "metadata": {
        "description": "mainiithink"
      }
    },
    "sqlAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "db"
      }
    },
    "sqlAdminPassword": {
      "type": "secureString",
      "metadata": {
        "description": "PortaL!234abcd"
      }
    },
    "sqlDbName": {
      "type": "string",
      "metadata": {
        "description": "accessmaindatabase"
      }
    },
    "sqlSkuName": {
      "type": "string",
      "defaultValue": "GP_S_Gen5",
      "allowedValues": ["GP_S_Gen5"],
      "metadata": {
        "description": "SQL Database SKU (General Purpose Gen5)"
      }
    },
    "openAiName": {
      "type": "string",
      "metadata": {
        "description": "openai-service"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "ihopethisworksstorage"
      }
    },
    "searchServiceName": {
      "type": "string",
      "metadata": {
        "description": "ihopethisworks-search"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2022-03-01",
      "name": "[parameters('servicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "tier": "Standard",
        "name": "S1"
      },
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2022-03-01",
      "name": "[parameters('siteName')]",
      "location": "[parameters('location')]",
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('servicePlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "PYTHON|3.10"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('servicePlanName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2022-05-01-preview",
      "name": "[parameters('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdminUsername')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "version": "12.0"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2022-05-01-preview",
      "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDbName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('sqlSkuName')]",
        "tier": "GeneralPurpose",
        "family": "Gen5",
        "capacity": 2
      },
      "properties": {
        "computeModel": "Serverless"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2022-05-01-preview",
      "name": "[format('{0}/{1}', parameters('sqlServerName'), 'AllowAllWindowsAzureIps')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2022-03-01",
      "name": "[format('{0}/connectionstrings', parameters('siteName'))]",
      "properties": {
        "DefaultConnection": {
          "value": "[concat('Server=tcp:', parameters('sqlServerName'), '.database.windows.net,1433;Initial Catalog=', parameters('sqlDbName'), ';Persist Security Info=False;User ID=', parameters('sqlAdminUsername'), ';Password=', parameters('sqlAdminPassword'), ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]",
          "type": "SQLAzure"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('sqlDbName'))]",
        "[resourceId('Microsoft.Web/sites', parameters('siteName'))]"
      ]
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[parameters('openAiName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "S0"
      },
      "kind": "OpenAI",
      "properties": {
        "apiProperties": {
          "qnaRuntimeEndpoint": ""
        },
        "customSubDomainName": "[concat(parameters('siteName'), '-openai')]"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}/default/mycontainer', parameters('storageAccountName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2023-11-01",
      "name": "[parameters('searchServiceName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "standard"
      },
      "properties": {
        "hostingMode": "default",
        "partitionCount": 1,
        "replicaCount": 1
      }
    }
  ]
}
